pipeline {
    agent any

    environment {
        VAULT_ADDR = "${VAULT_ADDR}"  // Replace with your Vault URL
    }

    stages {
        stage('Create Vault Secret') {
            steps {
                withVault(
                    configuration: [
                        vaultCredentialId: 'tech',
                        vaultUrl: "${VAULT_ADDR}"
                    ],
                    vaultSecrets: []
                ) {
                    script {
                        // Run your script with VAULT_TOKEN automatically injected
                        sh '''
                            echo "Writing secret to Vault using token from Jenkins..."
                            chmod +x vault_create_secret.sh
                            ./vault_create_secret.sh
                        '''
                    }
                }
            }
        }
    }

    post {
        failure {
            emailext(
                to: 'ashrithakp97@gmail.com',
                subject: 'Vault secret creation failed',
                body: 'Vault secret creation failed in Jenkins pipeline.'
            )
        }
    }
}
